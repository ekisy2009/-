<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Restaurant Manager Pro</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root {
    --primary: #2E4057;
    --accent: #048A81;
    --warning: #F4A261;
    --danger: #E76F51;
    --light-bg: #F8F9FA;
    --card-shadow: 0 4px 20px rgba(0,0,0,0.08);
  }
  body { background: #F0F4F8; font-family: 'Segoe UI', Tahoma, Arial, sans-serif; }
  .sidebar {
    width: 240px; min-height: 100vh; background: var(--primary);
    position: fixed; right: 0; top: 0; z-index: 100;
    display: flex; flex-direction: column;
  }
  .sidebar-logo {
    padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.1);
    color: white; text-align: center;
  }
  .sidebar-logo h5 { margin: 8px 0 0; font-weight: 700; font-size: 1.1rem; }
  .sidebar-logo small { opacity: 0.7; font-size: 0.75rem; }
  .nav-link-custom {
    display: flex; align-items: center; gap: 12px; padding: 12px 20px;
    color: rgba(255,255,255,0.75); text-decoration: none; cursor: pointer;
    transition: all 0.2s; border-right: 3px solid transparent;
  }
  .nav-link-custom:hover, .nav-link-custom.active {
    color: white; background: rgba(255,255,255,0.1);
    border-right-color: var(--accent);
  }
  .nav-link-custom i { width: 20px; text-align: center; }
  .main-content { margin-right: 240px; padding: 24px; min-height: 100vh; }
  .page { display: none; }
  .page.active { display: block; }
  .page-title { font-size: 1.6rem; font-weight: 700; color: var(--primary); margin-bottom: 6px; }
  .page-subtitle { color: #888; font-size: 0.9rem; margin-bottom: 24px; }
  .kpi-card {
    background: white; border-radius: 16px; padding: 20px 24px;
    box-shadow: var(--card-shadow); position: relative; overflow: hidden;
  }
  .kpi-card::before {
    content: ''; position: absolute; top: 0; right: 0;
    width: 4px; height: 100%; background: var(--accent);
  }
  .kpi-card.red::before { background: var(--danger); }
  .kpi-card.orange::before { background: var(--warning); }
  .kpi-card .kpi-icon {
    width: 48px; height: 48px; border-radius: 12px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem; margin-bottom: 12px; background: rgba(4,138,129,0.1);
    color: var(--accent);
  }
  .kpi-card .kpi-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
  .kpi-card .kpi-label { color: #888; font-size: 0.85rem; margin-top: 4px; }
  .chart-card {
    background: white; border-radius: 16px; padding: 20px;
    box-shadow: var(--card-shadow);
  }
  .chart-card h6 { font-weight: 700; color: var(--primary); margin-bottom: 16px; }
  .table-card {
    background: white; border-radius: 16px; padding: 20px;
    box-shadow: var(--card-shadow);
  }
  .table-card h5 { font-weight: 700; color: var(--primary); }
  .table thead th { color: var(--primary); font-weight: 600; border-bottom: 2px solid #eee; font-size: 0.85rem; }
  .table tbody td { font-size: 0.9rem; vertical-align: middle; }
  .badge-cat {
    padding: 4px 12px; border-radius: 20px; font-size: 0.78rem; font-weight: 500;
  }
  .badge-veggies { background: #E8F5E9; color: #2E7D32; }
  .badge-meat { background: #FCE4EC; color: #C62828; }
  .badge-drinks { background: #E3F2FD; color: #1565C0; }
  .badge-other { background: #F5F5F5; color: #616161; }
  .badge-dairy { background: #FFF3E0; color: #E65100; }
  .badge-status-draft { background: #FFF3E0; color: #E65100; }
  .badge-status-sent { background: #E3F2FD; color: #1565C0; }
  .badge-status-received { background: #E8F5E9; color: #2E7D32; }
  .btn-primary-custom {
    background: var(--accent); border: none; color: white;
    padding: 8px 20px; border-radius: 10px; font-weight: 500;
    transition: all 0.2s;
  }
  .btn-primary-custom:hover { background: #037068; color: white; transform: translateY(-1px); }
  .modal-header { background: var(--primary); color: white; }
  .modal-header .btn-close { filter: invert(1); }
  .upload-zone {
    border: 2px dashed #ccc; border-radius: 12px; padding: 40px;
    text-align: center; cursor: pointer; transition: all 0.2s;
    background: #FAFAFA;
  }
  .upload-zone:hover { border-color: var(--accent); background: #F0FDFC; }
  .upload-zone i { font-size: 2.5rem; color: #ccc; margin-bottom: 12px; }
  #uploadedPreview { max-width: 100%; border-radius: 8px; margin-top: 12px; }
  .ai-result-item {
    background: #F8F9FA; border-radius: 8px; padding: 12px;
    margin-bottom: 8px; border-right: 3px solid var(--accent);
  }
  .api-key-banner {
    background: #FFF3CD; border: 1px solid #FFC107; border-radius: 12px;
    padding: 12px 20px; margin-bottom: 20px; display: flex;
    align-items: center; gap: 12px;
  }
  .sidebar-version { padding: 16px 20px; color: rgba(255,255,255,0.4); font-size: 0.7rem; margin-top: auto; }
  .spinner-ai { display: none; }
  .loading .spinner-ai { display: inline-block; }
  .loading .scan-text { display: none; }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-logo">
    <i class="fa fa-utensils fa-2x" style="color: var(--accent)"></i>
    <h5>Restaurant Manager</h5>
    <small>ניהול מסעדה</small>
  </div>
  <nav style="padding: 12px 0;">
    <a class="nav-link-custom active" onclick="showPage('dashboard')">
      <i class="fa fa-chart-pie"></i> דשבורד
    </a>
    <a class="nav-link-custom" onclick="showPage('expenses')">
      <i class="fa fa-receipt"></i> מעקב הוצאות
    </a>
    <a class="nav-link-custom" onclick="showPage('orders')">
      <i class="fa fa-shopping-cart"></i> הזמנות ספקים
    </a>
    <a class="nav-link-custom" onclick="showPage('suppliers')">
      <i class="fa fa-truck"></i> ספקים
    </a>
    <a class="nav-link-custom" onclick="showPage('settings')">
      <i class="fa fa-gear"></i> הגדרות
    </a>
  </nav>
  <div class="sidebar-version">v1.0 | Restaurant Manager Pro</div>
</div>

<!-- Main Content -->
<div class="main-content">

  <!-- API Key Banner -->
  <div class="api-key-banner" id="apiBanner">
    <i class="fa fa-key text-warning fa-lg"></i>
    <div>
      <strong>הגדר מפתח Claude API</strong> – נדרש לניתוח תמונות תפריט.
      <a href="#" onclick="showPage('settings')" class="text-decoration-underline ms-2">להגדרות →</a>
    </div>
    <button class="btn btn-sm btn-outline-warning ms-auto" onclick="document.getElementById('apiBanner').style.display='none'">✕</button>
  </div>

  <!-- DASHBOARD -->
  <div class="page active" id="page-dashboard">
    <div class="page-title">דשבורד</div>
    <div class="page-subtitle" id="dashboardDate"></div>

    <!-- KPIs -->
    <div class="row g-3 mb-4">
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-icon"><i class="fa fa-shekel-sign"></i></div>
          <div class="kpi-value" id="kpi-month">₪0</div>
          <div class="kpi-label">הוצאות החודש</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card orange">
          <div class="kpi-icon" style="background:rgba(244,162,97,0.15);color:var(--warning)"><i class="fa fa-calendar-day"></i></div>
          <div class="kpi-value" id="kpi-today">₪0</div>
          <div class="kpi-label">הוצאות היום</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card red">
          <div class="kpi-icon" style="background:rgba(231,111,81,0.15);color:var(--danger)"><i class="fa fa-clock"></i></div>
          <div class="kpi-value" id="kpi-orders">0</div>
          <div class="kpi-label">הזמנות פתוחות</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="kpi-card">
          <div class="kpi-icon"><i class="fa fa-star"></i></div>
          <div class="kpi-value" id="kpi-top-supplier" style="font-size:1.1rem">-</div>
          <div class="kpi-label">ספק מוביל</div>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="row g-3 mb-4">
      <div class="col-md-7">
        <div class="chart-card">
          <h6><i class="fa fa-chart-bar me-2 text-primary"></i>הוצאות לפי חודש</h6>
          <canvas id="chartMonthly" height="200"></canvas>
        </div>
      </div>
      <div class="col-md-5">
        <div class="chart-card">
          <h6><i class="fa fa-chart-pie me-2 text-primary"></i>הוצאות לפי קטגוריה</h6>
          <canvas id="chartCategory" height="200"></canvas>
        </div>
      </div>
    </div>

    <!-- Recent Expenses Table -->
    <div class="table-card">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="mb-0">הוצאות אחרונות</h5>
        <button class="btn-primary-custom btn" onclick="showPage('expenses')">הצג הכל</button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr>
            <th>תאריך</th><th>ספק</th><th>קטגוריה</th><th>תיאור</th><th>סכום</th>
          </tr></thead>
          <tbody id="recentExpenses"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- EXPENSES -->
  <div class="page" id="page-expenses">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <div class="page-title">מעקב הוצאות</div>
        <div class="page-subtitle">ניהול כל ההוצאות של המסעדה</div>
      </div>
      <button class="btn-primary-custom btn" onclick="openExpenseModal()">
        <i class="fa fa-plus me-1"></i> הוצאה חדשה
      </button>
    </div>

    <!-- Filters -->
    <div class="table-card mb-3">
      <div class="row g-2">
        <div class="col-md-3">
          <input type="month" class="form-control" id="filterMonth" onchange="renderExpenses()">
        </div>
        <div class="col-md-3">
          <select class="form-select" id="filterCat" onchange="renderExpenses()">
            <option value="">כל הקטגוריות</option>
            <option>ירקות ופירות</option><option>בשר ועוף</option>
            <option>משקאות</option><option>מוצרי חלב</option><option>אחר</option>
          </select>
        </div>
        <div class="col-md-3">
          <input type="text" class="form-control" id="filterSearch" placeholder="חיפוש..." oninput="renderExpenses()">
        </div>
        <div class="col-md-3">
          <button class="btn btn-outline-secondary w-100" onclick="exportCSV()">
            <i class="fa fa-download me-1"></i> ייצוא CSV
          </button>
        </div>
      </div>
    </div>

    <div class="table-card">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead><tr>
            <th>תאריך</th><th>ספק</th><th>קטגוריה</th><th>תיאור</th><th>סכום</th><th>פעולות</th>
          </tr></thead>
          <tbody id="expensesTable"></tbody>
        </table>
        <div id="expensesEmpty" class="text-center text-muted py-4" style="display:none">
          <i class="fa fa-receipt fa-2x mb-2 d-block"></i> אין הוצאות עדיין
        </div>
      </div>
    </div>
  </div>

  <!-- ORDERS -->
  <div class="page" id="page-orders">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <div class="page-title">הזמנות ספקים</div>
        <div class="page-subtitle">הזמנה ידנית או לפי ניתוח תפריט</div>
      </div>
      <div class="d-flex gap-2">
        <button class="btn btn-outline-primary" onclick="openAIOrderModal()">
          <i class="fa fa-camera me-1"></i> הזמנה מתמונה
        </button>
        <button class="btn-primary-custom btn" onclick="openManualOrderModal()">
          <i class="fa fa-plus me-1"></i> הזמנה ידנית
        </button>
      </div>
    </div>

    <div class="row g-3" id="ordersGrid"></div>
    <div id="ordersEmpty" class="table-card text-center py-5 text-muted" style="display:none">
      <i class="fa fa-shopping-cart fa-2x mb-2 d-block"></i> אין הזמנות עדיין
    </div>
  </div>

  <!-- SUPPLIERS -->
  <div class="page" id="page-suppliers">
    <div class="d-flex justify-content-between align-items-start mb-3">
      <div>
        <div class="page-title">ניהול ספקים</div>
        <div class="page-subtitle">רשימת כל הספקים שלך</div>
      </div>
      <button class="btn-primary-custom btn" onclick="openSupplierModal()">
        <i class="fa fa-plus me-1"></i> ספק חדש
      </button>
    </div>
    <div class="row g-3" id="suppliersGrid"></div>
  </div>

  <!-- SETTINGS -->
  <div class="page" id="page-settings">
    <div class="page-title">הגדרות</div>
    <div class="page-subtitle">הגדרות מערכת וחיבור ל-AI</div>
    <div class="table-card" style="max-width:600px">
      <h6 class="fw-bold mb-3"><i class="fa fa-robot me-2 text-primary"></i>Claude API</h6>
      <div class="mb-3">
        <label class="form-label">מפתח API</label>
        <input type="password" class="form-control" id="apiKeyInput" placeholder="sk-ant-...">
        <div class="form-text">המפתח נשמר בדפדפן שלך בלבד ואינו נשלח לשרת</div>
      </div>
      <button class="btn-primary-custom btn" onclick="saveApiKey()">שמור מפתח</button>
      <div id="apiKeyStatus" class="mt-2"></div>

      <hr class="my-4">
      <h6 class="fw-bold mb-3"><i class="fa fa-trash me-2 text-danger"></i>איפוס נתונים</h6>
      <button class="btn btn-outline-danger" onclick="resetData()">מחק את כל הנתונים</button>
    </div>
  </div>

</div><!-- end main-content -->

<!-- Expense Modal -->
<div class="modal fade" id="expenseModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-white" id="expenseModalTitle">הוצאה חדשה</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="expenseId">
        <div class="mb-3"><label class="form-label">תאריך *</label>
          <input type="date" class="form-control" id="expDate"></div>
        <div class="mb-3"><label class="form-label">ספק *</label>
          <input type="text" class="form-control" id="expSupplier" placeholder="שם הספק" list="suppliersList">
          <datalist id="suppliersList"></datalist></div>
        <div class="mb-3"><label class="form-label">קטגוריה *</label>
          <select class="form-select" id="expCat">
            <option>ירקות ופירות</option><option>בשר ועוף</option>
            <option>משקאות</option><option>מוצרי חלב</option><option>אחר</option>
          </select></div>
        <div class="mb-3"><label class="form-label">תיאור</label>
          <input type="text" class="form-control" id="expDesc" placeholder="תיאור ההוצאה"></div>
        <div class="mb-3"><label class="form-label">סכום (₪) *</label>
          <input type="number" class="form-control" id="expAmount" placeholder="0.00" step="0.01"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
        <button type="button" class="btn-primary-custom btn" onclick="saveExpense()">שמור</button>
      </div>
    </div>
  </div>
</div>

<!-- Manual Order Modal -->
<div class="modal fade" id="manualOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-white">הזמנה ידנית</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">ספק *</label>
            <input type="text" class="form-control" id="orderSupplier" list="suppliersList2">
            <datalist id="suppliersList2"></datalist>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">תאריך הזמנה</label>
            <input type="date" class="form-control" id="orderDate">
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">פריטים</label>
          <div id="orderItems"></div>
          <button class="btn btn-sm btn-outline-secondary mt-2" onclick="addOrderItem()">
            <i class="fa fa-plus me-1"></i> הוסף פריט
          </button>
        </div>
        <div class="text-end fw-bold" id="orderTotal">סה"כ: ₪0</div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
        <button type="button" class="btn btn-outline-primary" onclick="saveOrder('draft')">שמור כטיוטה</button>
        <button type="button" class="btn-primary-custom btn" onclick="saveOrder('sent')">שלח הזמנה</button>
      </div>
    </div>
  </div>
</div>

<!-- AI Order Modal -->
<div class="modal fade" id="aiOrderModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-white"><i class="fa fa-robot me-2"></i>הזמנה לפי ניתוח תמונה</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">ספק</label>
          <input type="text" class="form-control" id="aiOrderSupplier" list="suppliersList3">
          <datalist id="suppliersList3"></datalist>
        </div>
        <div class="upload-zone" onclick="document.getElementById('menuImageInput').click()">
          <i class="fa fa-cloud-upload-alt d-block"></i>
          <p class="text-muted mb-0">לחץ להעלאת תמונת תפריט</p>
          <small class="text-muted">תומך ב-JPG, PNG, WEBP</small>
          <img id="uploadedPreview" style="display:none">
        </div>
        <input type="file" id="menuImageInput" accept="image/*" style="display:none" onchange="previewImage(this)">

        <div class="mt-3">
          <button class="btn-primary-custom btn w-100" id="analyzeBtn" onclick="analyzeMenu()" disabled>
            <span class="spinner-border spinner-border-sm spinner-ai me-2" role="status"></span>
            <span class="scan-text"><i class="fa fa-magic me-1"></i> נתח תפריט עם AI</span>
          </button>
        </div>

        <div id="aiResults" style="display:none" class="mt-3">
          <h6 class="fw-bold mb-3">פריטים שזוהו – ערוך לפי הצורך:</h6>
          <div id="aiResultItems"></div>
          <div class="text-end fw-bold mt-2" id="aiOrderTotal">סה"כ: ₪0</div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
        <button type="button" class="btn-primary-custom btn" id="confirmAiOrder" onclick="confirmAIOrder()" style="display:none">אשר הזמנה</button>
      </div>
    </div>
  </div>
</div>

<!-- Supplier Modal -->
<div class="modal fade" id="supplierModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-white">ספק חדש</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="supplierId">
        <div class="mb-3"><label class="form-label">שם הספק *</label>
          <input type="text" class="form-control" id="supplierName"></div>
        <div class="mb-3"><label class="form-label">קטגוריה</label>
          <select class="form-select" id="supplierCat">
            <option>ירקות ופירות</option><option>בשר ועוף</option>
            <option>משקאות</option><option>מוצרי חלב</option><option>אחר</option>
          </select></div>
        <div class="mb-3"><label class="form-label">טלפון</label>
          <input type="tel" class="form-control" id="supplierPhone"></div>
        <div class="mb-3"><label class="form-label">איש קשר</label>
          <input type="text" class="form-control" id="supplierContact"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
        <button type="button" class="btn-primary-custom btn" onclick="saveSupplier()">שמור</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ===== STATE =====
let state = {
  expenses: [],
  orders: [],
  suppliers: [],
  apiKey: ''
};

function loadState() {
  const saved = localStorage.getItem('rmstate');
  if (saved) state = JSON.parse(saved);
  else seedDemoData();
  if (!state.apiKey) state.apiKey = '';
}

function saveState() {
  localStorage.setItem('rmstate', JSON.stringify(state));
}

function seedDemoData() {
  const today = new Date();
  const m = (d) => {
    const dt = new Date(today); dt.setDate(d);
    return dt.toISOString().split('T')[0];
  };
  state.expenses = [
    { id:1, date:m(1), supplier:'ירקי הכרמל', category:'ירקות ופירות', desc:'עגבניות, מלפפונים, פלפלים', amount:850 },
    { id:2, date:m(3), supplier:'מאפיית לחם הארץ', category:'אחר', desc:'לחמים ולחמניות', amount:420 },
    { id:3, date:m(5), supplier:'כרמל בשרים', category:'בשר ועוף', desc:'אנטריקוט וחזה עוף', amount:2200 },
    { id:4, date:m(8), supplier:'מגדנות טבע', category:'מוצרי חלב', desc:'גבינות ושמנת', amount:680 },
    { id:5, date:m(10), supplier:'ירקי הכרמל', category:'ירקות ופירות', desc:'עשבי תיבול ופירות', amount:310 },
    { id:6, date:m(12), supplier:'אל גאל משקאות', category:'משקאות', desc:'שתייה קלה ומיצים', amount:950 },
    { id:7, date:m(14), supplier:'כרמל בשרים', category:'בשר ועוף', desc:'כבש טרי', amount:1800 },
    { id:8, date:m(15), supplier:'ירקי הכרמל', category:'ירקות ופירות', desc:'תפוחי אדמה ובצל', amount:280 },
  ];
  const prevMonth = new Date(today.getFullYear(), today.getMonth()-1, 15).toISOString().split('T')[0];
  state.expenses.push(
    { id:9, date:prevMonth, supplier:'כרמל בשרים', category:'בשר ועוף', desc:'הזמנה חודש שעבר', amount:3100 },
    { id:10, date:prevMonth, supplier:'ירקי הכרמל', category:'ירקות ופירות', desc:'ירקות חודש שעבר', amount:1200 },
  );
  state.suppliers = [
    { id:1, name:'ירקי הכרמל', category:'ירקות ופירות', phone:'050-1234567', contact:'יוסי לוי' },
    { id:2, name:'כרמל בשרים', category:'בשר ועוף', phone:'052-9876543', contact:'דוד כהן' },
    { id:3, name:'אל גאל משקאות', category:'משקאות', phone:'054-5557777', contact:'מירי אברהם' },
    { id:4, name:'מגדנות טבע', category:'מוצרי חלב', phone:'053-4443333', contact:'שרה לוי' },
  ];
  state.orders = [
    { id:1, supplier:'ירקי הכרמל', date:m(10), status:'received', items:[
      {name:'עגבניות', qty:10, unit:'ק"ג', price:8, total:80},
      {name:'מלפפונים', qty:5, unit:'ק"ג', price:6, total:30},
    ], total:110 },
    { id:2, supplier:'כרמל בשרים', date:m(14), status:'sent', items:[
      {name:'אנטריקוט', qty:8, unit:'ק"ג', price:120, total:960},
      {name:'חזה עוף', qty:10, unit:'ק"ג', price:35, total:350},
    ], total:1310 },
    { id:3, supplier:'אל גאל משקאות', date:m(16), status:'draft', items:[
      {name:'קולה', qty:24, unit:'בקבוקים', price:5, total:120},
    ], total:120 },
  ];
  saveState();
}

// ===== NAVIGATION =====
function showPage(name) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link-custom').forEach(n => n.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  event?.currentTarget?.classList.add('active');
  if (name === 'dashboard') renderDashboard();
  if (name === 'expenses') renderExpenses();
  if (name === 'orders') renderOrders();
  if (name === 'suppliers') renderSuppliers();
  if (name === 'settings') loadSettings();
}

// ===== DASHBOARD =====
let chartMonthly, chartCategory;

function renderDashboard() {
  const today = new Date();
  document.getElementById('dashboardDate').textContent =
    today.toLocaleDateString('he-IL', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  const todayStr = today.toISOString().split('T')[0];
  const monthStr = todayStr.slice(0,7);
  const monthExp = state.expenses.filter(e => e.date.startsWith(monthStr));
  const todayExp = state.expenses.filter(e => e.date === todayStr);
  const openOrders = state.orders.filter(o => o.status !== 'received');

  // Top supplier by expenses this month
  const bySupplier = {};
  monthExp.forEach(e => bySupplier[e.supplier] = (bySupplier[e.supplier]||0) + e.amount);
  const topS = Object.entries(bySupplier).sort((a,b)=>b[1]-a[1])[0];

  document.getElementById('kpi-month').textContent = '₪' + monthExp.reduce((s,e)=>s+e.amount,0).toLocaleString('he-IL');
  document.getElementById('kpi-today').textContent = '₪' + todayExp.reduce((s,e)=>s+e.amount,0).toLocaleString('he-IL');
  document.getElementById('kpi-orders').textContent = openOrders.length;
  document.getElementById('kpi-top-supplier').textContent = topS ? topS[0] : '-';

  // Monthly chart - last 6 months
  const months = [], monthData = [];
  for (let i=5; i>=0; i--) {
    const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
    const key = d.toISOString().slice(0,7);
    months.push(d.toLocaleDateString('he-IL', { month:'short', year:'2-digit' }));
    monthData.push(state.expenses.filter(e=>e.date.startsWith(key)).reduce((s,e)=>s+e.amount,0));
  }

  if (chartMonthly) chartMonthly.destroy();
  chartMonthly = new Chart(document.getElementById('chartMonthly'), {
    type: 'bar',
    data: { labels: months, datasets: [{
      label: 'הוצאות (₪)', data: monthData,
      backgroundColor: 'rgba(4,138,129,0.7)', borderRadius: 8
    }]},
    options: { responsive: true, plugins: { legend: { display: false } },
      scales: { y: { beginAtZero: true, ticks: { callback: v => '₪'+v.toLocaleString() } } } }
  });

  // Category pie
  const cats = {};
  monthExp.forEach(e => cats[e.category] = (cats[e.category]||0) + e.amount);
  if (chartCategory) chartCategory.destroy();
  chartCategory = new Chart(document.getElementById('chartCategory'), {
    type: 'doughnut',
    data: { labels: Object.keys(cats), datasets: [{
      data: Object.values(cats),
      backgroundColor: ['#048A81','#2E4057','#F4A261','#E76F51','#74C69D']
    }]},
    options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { font: { size: 12 } } } } }
  });

  // Recent expenses
  const recent = [...state.expenses].sort((a,b)=>b.date.localeCompare(a.date)).slice(0,5);
  document.getElementById('recentExpenses').innerHTML = recent.map(e => `
    <tr>
      <td>${formatDate(e.date)}</td>
      <td>${e.supplier}</td>
      <td><span class="badge-cat ${catClass(e.category)}">${e.category}</span></td>
      <td>${e.desc||'-'}</td>
      <td class="fw-bold">₪${e.amount.toLocaleString('he-IL')}</td>
    </tr>`).join('');
}

// ===== EXPENSES =====
function renderExpenses() {
  const m = document.getElementById('filterMonth').value;
  const cat = document.getElementById('filterCat').value;
  const q = document.getElementById('filterSearch').value.toLowerCase();
  let data = [...state.expenses].sort((a,b)=>b.date.localeCompare(a.date));
  if (m) data = data.filter(e => e.date.startsWith(m));
  if (cat) data = data.filter(e => e.category === cat);
  if (q) data = data.filter(e => (e.supplier+e.desc+e.category).toLowerCase().includes(q));

  const tbody = document.getElementById('expensesTable');
  tbody.innerHTML = data.map(e => `
    <tr>
      <td>${formatDate(e.date)}</td>
      <td>${e.supplier}</td>
      <td><span class="badge-cat ${catClass(e.category)}">${e.category}</span></td>
      <td>${e.desc||'-'}</td>
      <td class="fw-bold">₪${e.amount.toLocaleString('he-IL')}</td>
      <td>
        <button class="btn btn-sm btn-outline-secondary me-1" onclick="editExpense(${e.id})"><i class="fa fa-edit"></i></button>
        <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${e.id})"><i class="fa fa-trash"></i></button>
      </td>
    </tr>`).join('');
  document.getElementById('expensesEmpty').style.display = data.length ? 'none' : 'block';
}

function openExpenseModal(id=null) {
  document.getElementById('expenseId').value = id||'';
  document.getElementById('expenseModalTitle').textContent = id ? 'עריכת הוצאה' : 'הוצאה חדשה';
  if (id) {
    const e = state.expenses.find(x=>x.id===id);
    document.getElementById('expDate').value = e.date;
    document.getElementById('expSupplier').value = e.supplier;
    document.getElementById('expCat').value = e.category;
    document.getElementById('expDesc').value = e.desc||'';
    document.getElementById('expAmount').value = e.amount;
  } else {
    document.getElementById('expDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('expSupplier').value = '';
    document.getElementById('expDesc').value = '';
    document.getElementById('expAmount').value = '';
  }
  updateSupplierDatalist('suppliersList');
  new bootstrap.Modal(document.getElementById('expenseModal')).show();
}

function editExpense(id) { openExpenseModal(id); }

function saveExpense() {
  const id = document.getElementById('expenseId').value;
  const e = {
    id: id ? parseInt(id) : Date.now(),
    date: document.getElementById('expDate').value,
    supplier: document.getElementById('expSupplier').value.trim(),
    category: document.getElementById('expCat').value,
    desc: document.getElementById('expDesc').value.trim(),
    amount: parseFloat(document.getElementById('expAmount').value)||0
  };
  if (!e.date || !e.supplier || !e.amount) { alert('אנא מלא את כל השדות החובה'); return; }
  if (id) state.expenses = state.expenses.map(x => x.id===parseInt(id) ? e : x);
  else state.expenses.push(e);
  saveState();
  bootstrap.Modal.getInstance(document.getElementById('expenseModal')).hide();
  renderExpenses();
}

function deleteExpense(id) {
  if (!confirm('למחוק הוצאה זו?')) return;
  state.expenses = state.expenses.filter(e=>e.id!==id);
  saveState(); renderExpenses();
}

function exportCSV() {
  const rows = [['תאריך','ספק','קטגוריה','תיאור','סכום']];
  state.expenses.forEach(e => rows.push([e.date,e.supplier,e.category,e.desc||'',e.amount]));
  const csv = rows.map(r=>r.join(',')).join('\n');
  const a = document.createElement('a');
  a.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent('\uFEFF'+csv);
  a.download = 'expenses.csv'; a.click();
}

// ===== ORDERS =====
function renderOrders() {
  const grid = document.getElementById('ordersGrid');
  const empty = document.getElementById('ordersEmpty');
  const sorted = [...state.orders].sort((a,b)=>b.date.localeCompare(a.date));
  if (!sorted.length) { grid.innerHTML=''; empty.style.display='block'; return; }
  empty.style.display='none';
  const statusLabel = { draft:'טיוטה', sent:'נשלחה', received:'התקבלה' };
  const statusClass = { draft:'badge-status-draft', sent:'badge-status-sent', received:'badge-status-received' };
  grid.innerHTML = sorted.map(o => `
    <div class="col-md-6 col-lg-4">
      <div class="table-card h-100">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <div>
            <div class="fw-bold">${o.supplier}</div>
            <small class="text-muted">${formatDate(o.date)}</small>
          </div>
          <span class="badge-cat ${statusClass[o.status]}">${statusLabel[o.status]}</span>
        </div>
        <div class="small text-muted mb-2">${o.items.length} פריטים</div>
        <ul class="list-unstyled small mb-2">
          ${o.items.slice(0,3).map(i=>`<li>• ${i.name} × ${i.qty} ${i.unit||''} – ₪${i.total.toLocaleString()}</li>`).join('')}
          ${o.items.length>3?`<li class="text-muted">...ועוד ${o.items.length-3} פריטים</li>`:''}
        </ul>
        <div class="fw-bold text-end">סה"כ: ₪${o.total.toLocaleString('he-IL')}</div>
        <div class="d-flex gap-1 mt-2">
          ${o.status!=='received'?`<button class="btn btn-sm btn-outline-success flex-fill" onclick="markOrderReceived(${o.id})">✓ התקבל</button>`:''}
          <button class="btn btn-sm btn-outline-danger" onclick="deleteOrder(${o.id})"><i class="fa fa-trash"></i></button>
        </div>
      </div>
    </div>`).join('');
}

function markOrderReceived(id) {
  state.orders = state.orders.map(o => o.id===id ? {...o, status:'received'} : o);
  saveState(); renderOrders();
}
function deleteOrder(id) {
  if (!confirm('למחוק הזמנה זו?')) return;
  state.orders = state.orders.filter(o=>o.id!==id);
  saveState(); renderOrders();
}

// Manual Order
let manualItems = [];
function openManualOrderModal() {
  manualItems = [{ name:'', qty:1, unit:'יח\'', price:0, total:0 }];
  document.getElementById('orderDate').value = new Date().toISOString().split('T')[0];
  document.getElementById('orderSupplier').value = '';
  updateSupplierDatalist('suppliersList2');
  renderManualItems();
  new bootstrap.Modal(document.getElementById('manualOrderModal')).show();
}

function renderManualItems() {
  const div = document.getElementById('orderItems');
  div.innerHTML = manualItems.map((item,i) => `
    <div class="row g-2 mb-2 align-items-center">
      <div class="col-4"><input class="form-control form-control-sm" placeholder="שם פריט" value="${item.name}"
        oninput="manualItems[${i}].name=this.value"></div>
      <div class="col-2"><input class="form-control form-control-sm" type="number" placeholder="כמות" value="${item.qty}"
        oninput="manualItems[${i}].qty=+this.value;calcItem(${i})"></div>
      <div class="col-2"><input class="form-control form-control-sm" placeholder="יחידה" value="${item.unit}"
        oninput="manualItems[${i}].unit=this.value"></div>
      <div class="col-2"><input class="form-control form-control-sm" type="number" placeholder="מחיר" value="${item.price}"
        oninput="manualItems[${i}].price=+this.value;calcItem(${i})"></div>
      <div class="col-1 text-muted small">₪${item.total||0}</div>
      <div class="col-1"><button class="btn btn-sm btn-outline-danger" onclick="removeManualItem(${i})">✕</button></div>
    </div>`).join('');
  updateOrderTotal();
}

function calcItem(i) {
  manualItems[i].total = manualItems[i].qty * manualItems[i].price;
  updateOrderTotal();
}
function addOrderItem() { manualItems.push({name:'',qty:1,unit:'יח\'',price:0,total:0}); renderManualItems(); }
function removeManualItem(i) { manualItems.splice(i,1); renderManualItems(); }
function updateOrderTotal() {
  const t = manualItems.reduce((s,i)=>s+i.total,0);
  document.getElementById('orderTotal').textContent = 'סה"כ: ₪' + t.toLocaleString('he-IL');
}

function saveOrder(status) {
  const supplier = document.getElementById('orderSupplier').value.trim();
  if (!supplier) { alert('אנא הזן שם ספק'); return; }
  const items = manualItems.filter(i=>i.name.trim());
  if (!items.length) { alert('אנא הזן לפחות פריט אחד'); return; }
  state.orders.push({
    id: Date.now(), supplier,
    date: document.getElementById('orderDate').value,
    status, items,
    total: items.reduce((s,i)=>s+i.total,0)
  });
  saveState();
  bootstrap.Modal.getInstance(document.getElementById('manualOrderModal')).hide();
  renderOrders();
}

// AI Order
let aiItems = [];
function openAIOrderModal() {
  aiItems = [];
  document.getElementById('aiOrderSupplier').value = '';
  document.getElementById('uploadedPreview').style.display = 'none';
  document.getElementById('aiResults').style.display = 'none';
  document.getElementById('confirmAiOrder').style.display = 'none';
  document.getElementById('analyzeBtn').disabled = true;
  document.getElementById('menuImageInput').value = '';
  updateSupplierDatalist('suppliersList3');
  new bootstrap.Modal(document.getElementById('aiOrderModal')).show();
}

function previewImage(input) {
  const file = input.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = e => {
    const img = document.getElementById('uploadedPreview');
    img.src = e.target.result;
    img.style.display = 'block';
    document.getElementById('analyzeBtn').disabled = false;
  };
  reader.readAsDataURL(file);
}

async function analyzeMenu() {
  const apiKey = state.apiKey || localStorage.getItem('claudeApiKey');
  if (!apiKey) {
    alert('לא הוגדר מפתח Claude API. עבור להגדרות.');
    return;
  }
  const file = document.getElementById('menuImageInput').files[0];
  if (!file) { alert('אנא העלה תמונה'); return; }

  const btn = document.getElementById('analyzeBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  try {
    const base64 = await new Promise((res,rej) => {
      const r = new FileReader();
      r.onload = () => res(r.result.split(',')[1]);
      r.onerror = rej;
      r.readAsDataURL(file);
    });

    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': apiKey,
        'anthropic-version': '2023-06-01'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 1500,
        messages: [{
          role: 'user',
          content: [
            { type: 'image', source: { type: 'base64', media_type: file.type, data: base64 } },
            { type: 'text', text: 'אתה עוזר למנהל מסעדה. נתח את תמונת התפריט/קטלוג הספק הזה. החזר JSON בלבד (ללא תגיות markdown) עם מערך items שבו כל פריט מכיל: name (שם המוצר בעברית), qty (כמות מוצעת כמספר), unit (יחידת מידה בעברית), price (מחיר ליחידה כמספר). אם לא ניתן לזהות מחיר, השתמש ב-0. החזר עד 15 פריטים.' }
          ]
        }]
      })
    });

    if (!response.ok) {
      const err = await response.json();
      throw new Error(err.error?.message || 'שגיאת API');
    }

    const data = await response.json();
    const text = data.content[0].text;
    let parsed;
    try {
      parsed = JSON.parse(text);
    } catch {
      const match = text.match(/\[[\s\S]*\]/);
      if (match) parsed = { items: JSON.parse(match[0]) };
      else throw new Error('לא ניתן לנתח את תגובת ה-AI');
    }

    aiItems = (parsed.items || parsed).map(item => ({
      name: item.name, qty: item.qty||1, unit: item.unit||'יח\'',
      price: item.price||0, total: (item.qty||1)*(item.price||0)
    }));
    renderAIItems();
    document.getElementById('aiResults').style.display = 'block';
    document.getElementById('confirmAiOrder').style.display = 'inline-block';
  } catch(e) {
    alert('שגיאה: ' + e.message);
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

function renderAIItems() {
  const div = document.getElementById('aiResultItems');
  div.innerHTML = aiItems.map((item,i) => `
    <div class="ai-result-item">
      <div class="row g-2 align-items-center">
        <div class="col-4"><input class="form-control form-control-sm" value="${item.name}"
          oninput="aiItems[${i}].name=this.value"></div>
        <div class="col-2"><input class="form-control form-control-sm" type="number" value="${item.qty}"
          oninput="aiItems[${i}].qty=+this.value;aiItems[${i}].total=aiItems[${i}].qty*aiItems[${i}].price;renderAIItems()"></div>
        <div class="col-2"><input class="form-control form-control-sm" value="${item.unit}"
          oninput="aiItems[${i}].unit=this.value"></div>
        <div class="col-2"><input class="form-control form-control-sm" type="number" value="${item.price}"
          oninput="aiItems[${i}].price=+this.value;aiItems[${i}].total=aiItems[${i}].qty*aiItems[${i}].price;renderAIItems()"></div>
        <div class="col-1 fw-bold small">₪${item.total}</div>
        <div class="col-1"><button class="btn btn-sm btn-outline-danger" onclick="aiItems.splice(${i},1);renderAIItems()">✕</button></div>
      </div>
    </div>`).join('');
  const total = aiItems.reduce((s,i)=>s+i.total,0);
  document.getElementById('aiOrderTotal').textContent = 'סה"כ: ₪' + total.toLocaleString('he-IL');
}

function confirmAIOrder() {
  const supplier = document.getElementById('aiOrderSupplier').value.trim() || 'ספק לא ידוע';
  const items = aiItems.filter(i=>i.name.trim());
  state.orders.push({
    id: Date.now(), supplier,
    date: new Date().toISOString().split('T')[0],
    status: 'draft', items,
    total: items.reduce((s,i)=>s+i.total,0)
  });
  saveState();
  bootstrap.Modal.getInstance(document.getElementById('aiOrderModal')).hide();
  showPage('orders');
}

// ===== SUPPLIERS =====
function renderSuppliers() {
  const grid = document.getElementById('suppliersGrid');
  if (!state.suppliers.length) {
    grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="fa fa-truck fa-2x mb-2 d-block"></i>אין ספקים עדיין</div>';
    return;
  }
  grid.innerHTML = state.suppliers.map(s => {
    const totalSpend = state.expenses.filter(e=>e.supplier===s.name).reduce((sum,e)=>sum+e.amount,0);
    return `
    <div class="col-md-6 col-lg-4">
      <div class="table-card h-100">
        <div class="d-flex justify-content-between mb-2">
          <div>
            <div class="fw-bold fs-5">${s.name}</div>
            <span class="badge-cat ${catClass(s.category)}">${s.category}</span>
          </div>
          <div>
            <button class="btn btn-sm btn-outline-secondary me-1" onclick="editSupplier(${s.id})"><i class="fa fa-edit"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteSupplier(${s.id})"><i class="fa fa-trash"></i></button>
          </div>
        </div>
        ${s.phone?`<div class="small text-muted"><i class="fa fa-phone me-1"></i>${s.phone}</div>`:''}
        ${s.contact?`<div class="small text-muted"><i class="fa fa-user me-1"></i>${s.contact}</div>`:''}
        <div class="mt-2 pt-2 border-top small fw-bold">סה"כ קניות: ₪${totalSpend.toLocaleString('he-IL')}</div>
      </div>
    </div>`;
  }).join('');
}

function openSupplierModal(id=null) {
  document.getElementById('supplierId').value = id||'';
  if (id) {
    const s = state.suppliers.find(x=>x.id===id);
    document.getElementById('supplierName').value = s.name;
    document.getElementById('supplierCat').value = s.category;
    document.getElementById('supplierPhone').value = s.phone||'';
    document.getElementById('supplierContact').value = s.contact||'';
  } else {
    document.getElementById('supplierName').value = '';
    document.getElementById('supplierPhone').value = '';
    document.getElementById('supplierContact').value = '';
  }
  new bootstrap.Modal(document.getElementById('supplierModal')).show();
}

function editSupplier(id) { openSupplierModal(id); }

function saveSupplier() {
  const id = document.getElementById('supplierId').value;
  const s = {
    id: id ? parseInt(id) : Date.now(),
    name: document.getElementById('supplierName').value.trim(),
    category: document.getElementById('supplierCat').value,
    phone: document.getElementById('supplierPhone').value.trim(),
    contact: document.getElementById('supplierContact').value.trim(),
  };
  if (!s.name) { alert('אנא הזן שם ספק'); return; }
  if (id) state.suppliers = state.suppliers.map(x => x.id===parseInt(id) ? s : x);
  else state.suppliers.push(s);
  saveState();
  bootstrap.Modal.getInstance(document.getElementById('supplierModal')).hide();
  renderSuppliers();
}

function deleteSupplier(id) {
  if (!confirm('למחוק ספק זה?')) return;
  state.suppliers = state.suppliers.filter(s=>s.id!==id);
  saveState(); renderSuppliers();
}

// ===== SETTINGS =====
function loadSettings() {
  document.getElementById('apiKeyInput').value = state.apiKey || '';
}

function saveApiKey() {
  const key = document.getElementById('apiKeyInput').value.trim();
  state.apiKey = key;
  saveState();
  document.getElementById('apiKeyStatus').innerHTML = key ?
    '<div class="text-success small">✓ מפתח נשמר</div>' :
    '<div class="text-muted small">מפתח נמחק</div>';
  if (key) document.getElementById('apiBanner').style.display = 'none';
}

function resetData() {
  if (!confirm('למחוק את כל הנתונים? פעולה זו אינה הפיכה.')) return;
  localStorage.removeItem('rmstate');
  state = { expenses:[], orders:[], suppliers:[], apiKey:'' };
  saveState();
  alert('הנתונים אופסו. הדף יטען מחדש.');
  location.reload();
}

// ===== HELPERS =====
function formatDate(str) {
  if (!str) return '-';
  return new Date(str).toLocaleDateString('he-IL');
}

function catClass(cat) {
  if (cat === 'ירקות ופירות') return 'badge-veggies';
  if (cat === 'בשר ועוף') return 'badge-meat';
  if (cat === 'משקאות') return 'badge-drinks';
  if (cat === 'מוצרי חלב') return 'badge-dairy';
  return 'badge-other';
}

function updateSupplierDatalist(id) {
  document.getElementById(id).innerHTML = state.suppliers
    .map(s=>`<option value="${s.name}">`).join('');
}

// ===== INIT =====
loadState();
document.getElementById('filterMonth').value = new Date().toISOString().slice(0,7);
renderDashboard();
if (state.apiKey) document.getElementById('apiBanner').style.display = 'none';
</script>
</body>
</html>
